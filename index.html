<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maison Des Fleurs</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #0A0A0C; --text-main: #F4F0EB; --accent: #D4AF37; --card-bg: rgba(255, 255, 255, 0.05); }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Montserrat', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); padding-bottom: 80px; }
        h1, h2 { font-family: 'Playfair Display', serif; font-weight: 400; }
        
        .header { padding: 30px 20px; text-align: center; }
        .header h1 { font-size: 32px; letter-spacing: 2px; }
        .header p { color: #A09D98; font-size: 11px; letter-spacing: 3px; margin-top: 5px; }

        .catalog { padding: 0 20px; display: grid; gap: 20px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 15px; border: 1px solid rgba(255,255,255,0.08); }
        .card-title { font-size: 20px; color: var(--accent); margin-bottom: 8px; }
        .card-price { font-size: 18px; margin-bottom: 15px; font-weight: 600; }
        
        .add-btn { background: transparent; border: 1px solid var(--accent); color: var(--text-main); padding: 12px; border-radius: 20px; text-transform: uppercase; cursor: pointer; transition: 0.3s; width: 100%; font-size: 12px; font-weight: 600; }
        .qty-controls { display: none; justify-content: space-between; align-items: center; background: rgba(212, 175, 55, 0.1); border-radius: 20px; padding: 8px 20px; border: 1px solid var(--accent); }
        .qty-controls.active { display: flex; }
        .qty-btn { background: transparent; border: none; color: var(--accent); font-size: 24px; cursor: pointer; padding: 0 10px; }
        .qty-val { font-size: 18px; font-weight: 600; color: #fff; }

        /* Модалка оформления */
        .checkout-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 100; padding: 20px; overflow-y: auto; display: none; }
        .checkout-modal.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 12px; color: #A09D98; margin-bottom: 8px; text-transform: uppercase; }
        input, select, textarea { width: 100%; background: var(--card-bg); border: 1px solid #333; color: #fff; padding: 15px; border-radius: 12px; font-size: 14px; outline: none; }
        input:focus, textarea:focus { border-color: var(--accent); }
        .radio-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .radio-group label { background: var(--card-bg); padding: 15px; border-radius: 12px; flex: 1; text-align: center; border: 1px solid #333; cursor: pointer; font-size: 14px; }
        .radio-group input[type="radio"]:checked + label { border-color: var(--accent); color: var(--accent); background: rgba(212, 175, 55, 0.05); }
        .radio-group input[type="radio"] { display: none; }
        
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 28px; color: var(--text-main); text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <h1>L'Éphémère</h1>
        <p>ВЫСОКАЯ ФЛОРИСТИКА</p>
    </div>

    <div class="catalog" id="catalog-view">
        <div class="card" data-id="1" data-name="Эквадорская Роза" data-price="2990">
            <h2 class="card-title">Эквадорская Роза</h2>
            <div class="card-price">2 990 ₽</div>
            <button class="add-btn" onclick="addToCart(this)">В корзину</button>
            <div class="qty-controls">
                <button class="qty-btn" onclick="updateQty(this, -1)">-</button>
                <span class="qty-val">1</span>
                <button class="qty-btn" onclick="updateQty(this, 1)">+</button>
            </div>
        </div>
        
        <div class="card" data-id="2" data-name="Пионы Сара Бернар" data-price="4590">
            <h2 class="card-title">Пионы Сара Бернар</h2>
            <div class="card-price">4 590 ₽</div>
            <button class="add-btn" onclick="addToCart(this)">В корзину</button>
            <div class="qty-controls">
                <button class="qty-btn" onclick="updateQty(this, -1)">-</button>
                <span class="qty-val">1</span>
                <button class="qty-btn" onclick="updateQty(this, 1)">+</button>
            </div>
        </div>
    </div>

    <div class="checkout-modal" id="checkout-modal">
        <span class="close-modal" onclick="closeCheckout()">✕</span>
        <h2 style="margin-bottom: 25px; color: var(--accent); margin-top: 40px;">Оформление</h2>
        
        <div class="radio-group">
            <input type="radio" id="del" name="delivery" value="Доставка" checked onchange="toggleAddress(true)">
            <label for="del">Доставка</label>
            <input type="radio" id="pickup" name="delivery" value="Самовывоз" onchange="toggleAddress(false)">
            <label for="pickup">Самовывоз</label>
        </div>

        <div class="form-group">
            <label>Имя получателя *</label>
            <input type="text" id="c_name" placeholder="Иван Иванов">
        </div>
        <div class="form-group">
            <label>Телефон *</label>
            <input type="tel" id="c_phone" placeholder="+7 (999) 000-00-00">
        </div>
        <div class="form-group" id="address-group">
            <label>Адрес доставки *</label>
            <input type="text" id="c_address" placeholder="Улица, дом, квартира">
        </div>
        <div class="form-group">
            <label>Время (когда нужно) *</label>
            <input type="text" id="c_time" placeholder="Сегодня к 18:00">
        </div>
        <div class="form-group">
            <label>Комментарий</label>
            <textarea id="c_comment" rows="2" placeholder="Записка в букет..."></textarea>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // Настраиваем нативную кнопку Telegram
        tg.MainButton.textColor = "#0A0A0C";
        tg.MainButton.color = "#D4AF37";

        let cart = {}; 

        function addToCart(btn) {
            const card = btn.closest('.card');
            const id = card.dataset.id;
            
            cart[id] = {
                name: card.dataset.name,
                price: parseInt(card.dataset.price),
                qty: 1
            };
            
            btn.style.display = 'none';
            card.querySelector('.qty-controls').classList.add('active');
            updateCartUI();
        }

        function updateQty(btn, change) {
            const card = btn.closest('.card');
            const id = card.dataset.id;
            
            cart[id].qty += change;
            
            if (cart[id].qty <= 0) {
                delete cart[id];
                card.querySelector('.qty-controls').classList.remove('active');
                card.querySelector('.add-btn').style.display = 'block';
            } else {
                card.querySelector('.qty-val').innerText = cart[id].qty;
            }
            updateCartUI();
        }

        function updateCartUI() {
            let total = 0;
            let itemsCount = 0;
            
            for (let id in cart) {
                total += cart[id].price * cart[id].qty;
                itemsCount += cart[id].qty;
            }
            
            if (itemsCount > 0) {
                // Если мы НЕ в режиме оформления, показываем кнопку "Перейти к оформлению"
                if (!document.getElementById('checkout-modal').classList.contains('active')) {
                    tg.MainButton.setText(`ОФОРМИТЬ ЗАКАЗ НА ${total} ₽`);
                    tg.MainButton.show();
                    tg.MainButton.onClick(openCheckout);
                }
            } else {
                tg.MainButton.hide();
                closeCheckout();
            }
        }

        function openCheckout() {
            document.getElementById('checkout-modal').classList.add('active');
            document.getElementById('catalog-view').style.display = 'none';
            
            // Меняем поведение главной кнопки на отправку данных
            tg.MainButton.offClick(openCheckout);
            tg.MainButton.setText('ПОДТВЕРДИТЬ И ОТПРАВИТЬ');
            tg.MainButton.onClick(sendOrder);
        }

        function closeCheckout() {
            document.getElementById('checkout-modal').classList.remove('active');
            document.getElementById('catalog-view').style.display = 'grid';
            
            // Возвращаем кнопку в режим корзины
            tg.MainButton.offClick(sendOrder);
            updateCartUI(); 
        }

        function toggleAddress(show) {
            document.getElementById('address-group').style.display = show ? 'block' : 'none';
        }

        function sendOrder() {
            const deliveryType = document.querySelector('input[name="delivery"]:checked').value;
            const name = document.getElementById('c_name').value.trim();
            const phone = document.getElementById('c_phone').value.trim();
            const address = document.getElementById('c_address').value.trim();
            const time = document.getElementById('c_time').value.trim();
            const comment = document.getElementById('c_comment').value.trim();

            if (!name || !phone || !time || (deliveryType === 'Доставка' && !address)) {
                tg.showAlert("⚠️ Пожалуйста, заполните все обязательные поля (Имя, Телефон, Адрес, Время)");
                return;
            }

            let itemsArr = [];
            let totalSum = 0;
            for (let id in cart) {
                itemsArr.push(cart[id]);
                totalSum += cart[id].price * cart[id].qty;
            }

            const finalData = {
                items: itemsArr,
                total: totalSum,
                delivery_type: deliveryType,
                name: name,
                phone: phone,
                address: address,
                time: time,
                comment: comment
            };

            tg.HapticFeedback.notificationOccurred('success');
            // Вот та самая магия, которая теперь 100% сработает
            tg.sendData(JSON.stringify(finalData));
        }
    </script>
</body>
</html>